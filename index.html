<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地胶拼接可视化工具</title>
    <script src="https://cdn.tailwindcss.com?v=20240607"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?v=20240607" rel="stylesheet">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#3b82f6',
                        accent: '#f97316',
                        neutral: '#f3f4f6',
                        dark: '#1f2937'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .shadow-soft {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary;
            }
            .btn-hover {
                @apply hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300;
            }
            .modal-backdrop {
                @apply fixed inset-0 bg-black/50 flex items-center justify-center z-50;
            }
            .modal-content {
                @apply bg-white rounded-lg p-5 max-w-sm w-full mx-4 shadow-lg;
            }
            .btn-copied {
                @apply bg-green-600 hover:bg-green-700 transition-all duration-300;
            }
            .update-modal {
                @apply z-50 fixed inset-0 bg-black/30 flex items-center justify-center p-4;
            }
            .update-content {
                @apply bg-white rounded-xl shadow-xl max-w-sm w-full max-h-[70vh] overflow-y-auto;
            }
            .update-header {
                @apply bg-primary text-white p-4 rounded-t-xl flex justify-between items-center;
            }
            .update-body {
                @apply p-4 space-y-3 text-sm;
            }
            .update-footer {
                @apply p-3 border-t border-gray-100 flex justify-end;
            }
            /* 新增分段输入弹窗样式 */
            .segment-modal {
                @apply fixed inset-0 bg-black/50 flex items-center justify-center z-50;
            }
            .segment-content {
                @apply bg-white rounded-lg p-6 max-w-sm w-full mx-4 shadow-lg;
            }
            .segment-input {
                @apply w-full px-4 py-2.5 border border-gray-300 rounded-lg input-focus transition-all-300 shadow-sm mt-2 mb-4;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-inter text-dark min-h-screen" data-app-version="20241101">
    <!-- 更新公告弹窗 - 修改后版本 -->
    <div id="update-modal" class="update-modal hidden">
        <div class="update-content">
            <div class="update-header">
                <h2 class="text-base font-bold">✨ 功能重磅升级</h2>
                <button id="close-update" class="text-white hover:text-gray-200 transition-colors p-1">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="update-body">
                <div class="flex items-start p-3 bg-blue-50 rounded-lg">
                    <div class="text-primary mt-1 mr-2 text-xl">
                        <i class="fa fa-magic"></i>
                    </div>
                    <div class="w-full">
                        <h3 class="font-semibold text-gray-800 mb-2">1.8米宽幅地胶 全场景智能填充</h3>
                        <p class="text-gray-600 leading-relaxed">
                            已支持<span class="text-accent font-medium">小于0.4米、除三乘二</span>等所有余数场景，<br>
                            任意余数均可<span class="text-primary font-medium">一键智能填充</span>，从此一劳永逸！<br>
                            操作更便捷，效率再提升！
                        </p>
                    </div>
                </div>
            </div>
            <div class="update-footer">
                <button id="confirm-update" class="bg-primary hover:bg-primary/90 text-white font-medium py-1 px-3 rounded-lg transition-all duration-300 text-sm">
                    立即体验
                </button>
            </div>
        </div>
    </div>

    <!-- 提示对话框 -->
    <div id="message-modal" class="modal-backdrop hidden" style="display: none;">
        <div class="modal-content">
            <div class="text-center mb-3">
                <i id="modal-icon" class="fa fa-info-circle text-3xl text-primary mb-2"></i>
                <p id="modal-message" class="text-base"></p>
            </div>
            <button id="modal-ok" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-1.5 px-3 rounded-lg transition-all-300 text-sm">
                确定
            </button>
        </div>
    </div>

    <!-- 新增：余数<0.4米 自定义分段输入弹窗 -->
    <div id="segment-modal" class="segment-modal hidden" style="display: none;">
        <div class="segment-content">
            <h3 class="text-lg font-bold text-primary flex items-center">
                <i class="fa fa-split mr-2"></i>自定义分段填充
            </h3>
            <p class="text-gray-600 mt-2" id="segment-tip">
                检测到余数宽度：<span id="segment-remainder" class="font-semibold text-accent"></span>米（小于0.4米）
            </p>
            <p class="text-gray-700">请输入要分成的段数（正整数）：</p>
            <input type="number" id="segment-count" class="segment-input" min="1" step="1" placeholder="例如：4、5、6">
            <div class="flex gap-3 mt-2">
                <button id="segment-cancel" class="flex-1 bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg btn-hover">
                    取消
                </button>
                <button id="segment-confirm" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg btn-hover">
                    确认填充
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 顶部标题和Logo -->
        <header class="mb-6 flex flex-col sm:flex-row items-start sm:items-center gap-4">
            <!-- 左侧logo -->
            <div class="flex-shrink-0">
                <img src="https://s41.ax1x.com/2026/01/03/pZUjfv6.png" 
                     alt="欧百娜logo" 
                     class="h-16 sm:h-20 object-contain mt-[-10px]">
            </div>
            
            <!-- 右侧标题和说明文字 -->
            <div class="flex flex-col">
                <h1 class="text-[clamp(1.75rem,3vw,2.5rem)] font-bold text-dark">地胶拼接可视化工具</h1>
                <p class="text-gray-600 mt-1">精确规划您的场地地胶布局，支持自定义尺寸和排列方式</p>
            </div>
        </header>

        <!-- 主要内容区 -->
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- 左侧输入控制区 -->
            <div class="lg:w-1/3 space-y-5">
                <!-- 场地设置卡片 - 紧凑布局 -->
                <div class="bg-white rounded-xl shadow-soft p-5 border border-gray-100 transition-all-300 hover:shadow-md">
                    <h2 class="text-xl font-bold mb-3 flex items-center text-primary">
                        <i class="fa fa-arrows-alt mr-2"></i>场地设置
                    </h2>
                    <div class="space-y-3">
                        <div>
                            <label for="field-width" class="block text-sm font-medium text-gray-700 mb-1">
                                场地宽度 (米)
                            </label>
                            <input type="number" id="field-width" min="0.1" step="0.1" 
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg input-focus transition-all-300 shadow-sm">
                        </div>
                        <div>
                            <label for="field-length" class="block text-sm font-medium text-gray-700 mb-1">
                                场地长度 (米)
                            </label>
                            <input type="number" id="field-length" min="0.1" step="0.1" 
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg input-focus transition-all-300 shadow-sm">
                        </div>
                        <!-- 标准地胶宽度选择 - 1行显示 -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">标准地胶宽度 (米)</label>
                            <div class="grid grid-cols-4 gap-2">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="standard-mat-width" value="1.5" class="mr-2 h-4 w-4 text-primary focus:ring-primary">
                                    <span>1.5米</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="standard-mat-width" value="1.6" class="mr-2 h-4 w-4 text-primary focus:ring-primary">
                                    <span>1.6米</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="standard-mat-width" value="1.8" checked class="mr-2 h-4 w-4 text-primary focus:ring-primary">
                                    <span>1.8米</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="standard-mat-width" value="2.0" class="mr-2 h-4 w-4 text-primary focus:ring-primary">
                                    <span>2.0米</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-1">
                            <button id="generate-btn" 
                                class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg btn-hover flex items-center justify-center shadow-sm">
                                <i class="fa fa-magic mr-2"></i>生成地胶
                            </button>
                            <button id="reset-btn" disabled 
                                class="bg-gray-200 text-gray-700 font-medium py-2.5 px-4 rounded-lg btn-hover flex items-center justify-center shadow-sm">
                                <i class="fa fa-refresh mr-2"></i>重置
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 地胶配置卡片 - 调整间距 -->
                <div class="bg-white rounded-xl shadow-soft p-5 border border-gray-100 transition-all-300 hover:shadow-md">
                    <h2 class="text-xl font-bold mb-4 flex items-center text-primary">
                        <i class="fa fa-puzzle-piece mr-2"></i>地胶配置
                    </h2>
                    
                    <!-- 添加自定义地胶 - 增加内部间距 -->
                    <div class="space-y-4">
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <h3 class="font-semibold mb-3 flex items-center text-accent">
                                <i class="fa fa-plus-circle mr-2"></i>添加地胶
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1.5">宽度 (米)</label>
                                    <input type="number" class="custom-mat-width w-full px-4 py-2.5 border border-gray-300 rounded-lg input-focus transition-all-300 shadow-sm" min="0.1" step="0.1">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1.5">长度 (米)</label>
                                    <input type="number" class="custom-mat-length w-full px-4 py-2.5 border border-gray-300 rounded-lg input-focus transition-all-300 shadow-sm" min="0.1" step="0.1">
                                </div>
                                <button class="add-mat-btn w-full bg-accent hover:bg-accent/90 text-white font-medium py-2.5 px-4 rounded-lg btn-hover flex items-center justify-center shadow-sm">
                                    <i class="fa fa-plus mr-2"></i>手动添加地胶
                                </button>
                                
                                <!-- 增加按钮之间的间距 -->
                                <button id="smart-add-btn" disabled
                                    class="w-full bg-primary/90 hover:bg-primary text-white font-medium py-2.5 px-4 rounded-lg btn-hover flex items-center justify-center shadow-sm mt-3">
                                    <i class="fa fa-lightbulb-o mr-2"></i>无需输入一键智能添加地胶
                                </button>
                                
                                <!-- 提示信息区域 -->
                                <div id="smart-add-message" class="mt-3 text-sm text-orange-500">
                                    智能添加只支持1.8米宽幅地胶
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧画布显示区 -->
            <div class="lg:w-2/3 space-y-6">
                <div class="bg-white rounded-xl shadow-soft border border-gray-100 overflow-hidden transition-all-300 hover:shadow-md">
                    <div class="p-3 border-b border-gray-100 flex justify-between items-center">
                        <h2 class="text-xl font-bold flex items-center text-primary">
                            <i class="fa fa-paint-brush mr-2"></i>地胶预览
                        </h2>
                        <div class="flex gap-2">
                            <!-- 撤销按钮 -->
                            <button id="undo-btn" disabled 
                                class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg btn-hover flex items-center justify-center shadow-sm">
                                <i class="fa fa-undo mr-2"></i>撤销
                            </button>
                            <button id="copy-btn" disabled class="bg-secondary hover:bg-secondary/90 text-white font-medium py-2.5 px-4 rounded-lg btn-hover flex items-center justify-center shadow-sm">
                                <i class="fa fa-copy mr-2"></i>复制拼装图
                            </button>
                        </div>
                    </div>
                    <div class="p-3 bg-gray-50 relative" id="canvas-container">
                        <canvas id="canvas" class="w-full rounded-lg shadow-inner bg-white"></canvas>
                        <!-- 画布为空时的提示信息 -->
                        <div id="empty-canvas-message" class="absolute inset-0 flex items-center justify-center text-gray-400 text-lg">
                            <div class="text-center">
                                <i class="fa fa-th-large text-5xl mb-3 text-gray-300"></i>
                                <p class="text-gray-500">请设置场地尺寸并生成地胶</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 地胶文字大小调整 -->
                <div class="bg-white rounded-xl shadow-soft p-5 border border-gray-100 transition-all-300 hover:shadow-md">
                    <h2 class="text-xl font-bold mb-3 flex items-center text-primary">
                        <i class="fa fa-text-height mr-2"></i>地胶文字大小
                    </h2>
                    <div class="flex items-center space-x-3">
                        <button id="decrease-font-size" class="w-10 h-10 bg-gray-200 hover:bg-gray-300 rounded-lg flex items-center justify-center btn-hover">
                            <i class="fa fa-minus text-gray-700"></i>
                        </button>
                        <span id="font-size-value" class="text-gray-700 font-medium">16px</span>
                        <button id="increase-font-size" class="w-10 h-10 bg-gray-200 hover:bg-gray-300 rounded-lg flex items-center justify-center btn-hover">
                            <i class="fa fa-plus text-gray-700"></i>
                        </button>
                        <input type="range" id="font-size-slider" min="8" max="100" value="16" step="1" 
                            class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>

                <!-- 操作指南卡片 -->
                <div class="bg-white rounded-xl shadow-soft p-5 border border-gray-100 transition-all-300 hover:shadow-md">
                    <h2 class="text-xl font-bold mb-3 flex items-center text-primary">
                        <i class="fa fa-info-circle mr-2"></i>操作指南
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-gray-700">
                        <div class="flex items-start">
                            <i class="fa fa-check-circle text-green-500 mt-1 mr-2"></i>
                            <span>所有地胶都可以自由拖动和旋转</span>
                        </div>
                        <div class="flex items-start">
                            <i class="fa fa-check-circle text-green-500 mt-1 mr-2"></i>
                            <span>红色区域表示需要额外添加地胶的部分</span>
                        </div>
                        <div class="flex items-start">
                            <i class="fa fa-check-circle text-green-500 mt-1 mr-2"></i>
                            <span><b>按住Shift键并点击地胶可删除</b></span>
                        </div>
                        <div class="flex items-start">
                            <i class="fa fa-check-circle text-green-500 mt-1 mr-2"></i>
                            <span>可通过滑块或按钮调整地胶内文字大小</span>
                        </div>
                        <div class="flex items-start">
                            <i class="fa fa-check-circle text-green-500 mt-1 mr-2"></i>
                            <span>点击"复制拼装图"按钮可一键复制图片</span>
                        </div>
                        <div class="flex items-start">
                            <i class="fa fa-check-circle text-green-500 mt-1 mr-2"></i>
                            <span>复制后可直接粘贴到其他应用中使用</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 确保弹窗初始状态为隐藏
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，初始化弹窗逻辑');
            
            // 检查是否已显示过更新公告（原始版本localStorage键）
            const hasShownUpdate = localStorage.getItem('hasShownUpdate_20241101');
            const updateModal = document.getElementById('update-modal');
            
            // 如果未显示过，显示更新公告
            if (!hasShownUpdate) {
                console.log('首次加载，显示更新公告弹窗');
                updateModal.classList.remove('hidden');
                updateModal.style.display = 'flex';
                localStorage.setItem('hasShownUpdate_20241101', 'true');
            }
            
            // 关闭更新公告的通用函数
            function closeUpdateModal() {
                updateModal.classList.add('hidden');
                updateModal.style.display = 'none';
                document.body.style.overflow = '';
            }
            
            // 关闭按钮/确认按钮/空白处/ESC键关闭公告弹窗
            document.addEventListener('click', function(e) {
                if (e.target.id === 'close-update' || e.target.parentElement.id === 'close-update' || e.target.id === 'confirm-update') {
                    closeUpdateModal();
                }
                if (e.target === updateModal) closeUpdateModal();
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeUpdateModal();
                    if (messageModal.style.display !== 'none') hideModal();
                    if (segmentModal.style.display !== 'none') hideSegmentModal();
                }
            });
            
            // 强制设置消息弹窗初始状态
            const messageModal = document.getElementById('message-modal');
            messageModal.style.display = 'none';
            // 初始化分段弹窗相关元素
            const segmentModal = document.getElementById('segment-modal');
            const segmentCount = document.getElementById('segment-count');
            const segmentRemainder = document.getElementById('segment-remainder');
            const segmentConfirm = document.getElementById('segment-confirm');
            const segmentCancel = document.getElementById('segment-cancel');
            // 全局变量存储当前余数（用于分段填充）
            let currentRemainder = 0;
            
            // 余数区域地胶颜色
            const REMAINDER_MAT_COLOR = '#D0823D';
            // 操作历史记录
            const history = [];
            const MAX_HISTORY = 50;
            // 浮点数精度修复
            function precisionFix(num, decimals = 2) {
                return Number(num.toFixed(decimals));
            }

            // 保存状态/撤销/更新撤销按钮
            function saveState() {
                const state = { mats: JSON.parse(JSON.stringify(mats)), fieldLength, fieldWidth, scale, FIELD_X, FIELD_Y };
                history.push(state);
                if (history.length > MAX_HISTORY) history.shift();
                updateUndoButtonState();
            }
            function undo() {
                if (history.length === 0) { showModal("没有可撤销的操作", true); return; }
                const prevState = history.pop();
                mats = JSON.parse(JSON.stringify(prevState.mats));
                fieldLength = prevState.fieldLength; fieldWidth = prevState.fieldWidth;
                scale = prevState.scale; FIELD_X = prevState.FIELD_X; FIELD_Y = prevState.FIELD_Y;
                updateMatConfig(); updateSmartAddButtonState(); updateUndoButtonState();
                resizeCanvas(); drawCanvas();
                document.getElementById('reset-btn').disabled = mats.length === 0;
                document.getElementById('copy-btn').disabled = mats.length === 0;
                document.getElementById('empty-canvas-message').style.display = mats.length === 0 ? 'flex' : 'none';
            }
            function updateUndoButtonState() {
                const undoBtn = document.getElementById('undo-btn');
                undoBtn.disabled = history.length === 0;
                undoBtn.classList.toggle('bg-gray-200', history.length === 0);
                undoBtn.classList.toggle('bg-gray-300', history.length > 0);
            }

            // 复制拼装图
            function copyToClipboard() {
                const copyBtn = document.getElementById('copy-btn');
                const originalText = copyBtn.innerHTML;
                canvas.toBlob(blob => {
                    try {
                        navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]).then(() => {
                            copyBtn.innerHTML = '<i class="fa fa-check mr-2"></i>已复制';
                            copyBtn.classList.add('btn-copied');
                            setTimeout(() => { copyBtn.innerHTML = originalText; copyBtn.classList.remove('btn-copied'); }, 2000);
                            showModal("拼装图已成功复制到剪贴板，可直接粘贴使用");
                        }).catch(err => { console.error('复制失败:', err); showModal("复制失败，请尝试刷新页面后重试", true); });
                    } catch (err) {
                        const imgUrl = canvas.toDataURL('image/png');
                        const tempLink = document.createElement('a');
                        tempLink.href = imgUrl; tempLink.download = '地胶拼装图.png';
                        document.body.appendChild(tempLink); tempLink.click(); document.body.removeChild(tempLink);
                        showModal("您的浏览器不支持直接复制图片，已为您下载图片文件", true);
                    }
                });
            }

            // 画布基础参数
            let CANVAS_WIDTH = 1200;
            let CANVAS_HEIGHT = 600;
            const MARGIN = 20;
            const SNAP_THRESHOLD = 15;
            let fieldLength = 0;
            let fieldWidth = 0;
            let scale = 40;
            let matFontSize = 16;
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            let FIELD_X = MARGIN;
            let FIELD_Y = MARGIN;
            let mats = [];

            // 拖拽/Shift键/弹窗相关变量
            let isDragging = false;
            let draggedMatIndex = -1;
            let offsetX, offsetY;
            let startMatState = null;
            let isStateSaved = false;
            let isShiftKeyDown = false;
            const modalMessage = document.getElementById('modal-message');
            const modalIcon = document.getElementById('modal-icon');
            const modalOk = document.getElementById('modal-ok');

            // 初始化事件监听
            function initEvents() {
                // 按钮事件
                document.getElementById('undo-btn').addEventListener('click', undo);
                document.getElementById('generate-btn').addEventListener('click', () => { saveState(); generateMats(); });
                document.getElementById('reset-btn').addEventListener('click', () => { saveState(); reset(); });
                document.getElementById('copy-btn').addEventListener('click', copyToClipboard);
                document.getElementById('smart-add-btn').addEventListener('click', () => { saveState(); smartAddMats(); });
                modalOk.addEventListener('click', hideModal);
                messageModal.addEventListener('click', (e) => { if (e.target === messageModal) hideModal(); });
                // 分段弹窗事件
                segmentConfirm.addEventListener('click', confirmSegmentFill);
                segmentCancel.addEventListener('click', hideSegmentModal);
                segmentModal.addEventListener('click', (e) => { if (e.target === segmentModal) hideSegmentModal(); });

                // 画布鼠标事件
                canvas.addEventListener('mousedown', handleMouseDown);
                canvas.addEventListener('mousemove', handleMouseMove);
                canvas.addEventListener('mouseup', handleMouseUp);
                canvas.addEventListener('mouseleave', handleMouseUp);
                canvas.addEventListener('contextmenu', (e) => { e.preventDefault(); if (draggedMatIndex >= 0) { saveState(); rotateMat(draggedMatIndex); } });

                // 输入框/单选框事件
                document.getElementById('field-length').addEventListener('input', updateFieldDimensions);
                document.getElementById('field-width').addEventListener('input', updateFieldDimensions);
                document.querySelectorAll('input[name="standard-mat-width"]').forEach(radio => radio.addEventListener('change', updateSmartAddButtonState));
                document.addEventListener('click', (e) => { if (e.target.classList.contains('add-mat-btn')) { saveState(); addCustomMat(); } });

                // 窗口大小/Shift键/文字大小调整
                window.addEventListener('resize', resizeCanvas);
                document.addEventListener('keydown', (e) => { if (e.key === 'Shift') isShiftKeyDown = true; });
                document.addEventListener('keyup', (e) => { if (e.key === 'Shift') isShiftKeyDown = false; });
                const fontSizeSlider = document.getElementById('font-size-slider');
                const decreaseBtn = document.getElementById('decrease-font-size');
                const increaseBtn = document.getElementById('increase-font-size');
                const fontSizeValue = document.getElementById('font-size-value');
                fontSizeSlider.addEventListener('input', () => { saveState(); matFontSize = parseInt(this.value); fontSizeValue.textContent = `${matFontSize}px`; drawCanvas(); });
                decreaseBtn.addEventListener('click', () => { if (matFontSize > 8) { saveState(); matFontSize -= 1; fontSizeSlider.value = matFontSize; fontSizeValue.textContent = `${matFontSize}px`; drawCanvas(); } });
                increaseBtn.addEventListener('click', () => { saveState(); matFontSize += 1; fontSizeSlider.value = matFontSize; fontSizeValue.textContent = `${matFontSize}px`; drawCanvas(); });
            }

            // 更新智能添加按钮状态
            function updateSmartAddButtonState() {
                const standardMatWidth = getStandardMatWidth();
                const smartAddBtn = document.getElementById('smart-add-btn');
                smartAddBtn.disabled = standardMatWidth !== 1.8 || mats.length === 0;
            }

            // 通用弹窗显示/隐藏
            function showModal(message, isWarning = false) {
                if (!message || message.trim() === '') return;
                modalMessage.textContent = message;
                modalIcon.className = isWarning ? "fa fa-exclamation-triangle text-3xl text-orange-500 mb-2" : "fa fa-info-circle text-3xl text-primary mb-2";
                messageModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            function hideModal() {
                messageModal.style.display = 'none';
                document.body.style.overflow = '';
            }

            // 新增：分段填充弹窗显示/隐藏
            function showSegmentModal(remainder) {
                currentRemainder = remainder;
                segmentRemainder.textContent = remainder.toFixed(2);
                segmentCount.value = '';
                segmentCount.focus();
                segmentModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            function hideSegmentModal() {
                segmentModal.style.display = 'none';
                document.body.style.overflow = '';
                currentRemainder = 0;
            }

            // 新增：分段填充确认逻辑
            function confirmSegmentFill() {
                const count = parseInt(segmentCount.value);
                // 校验输入：必须是正整数
                if (isNaN(count) || count < 1 || !Number.isInteger(count)) {
                    showModal("请输入有效的正整数段数（例如：4、5、6）", true);
                    return;
                }
                // 计算单条地胶长度：场地长 / 输入段数
                const singleLength = precisionFix(fieldLength / count);
                // 执行填充
                addSmartMats(count, currentRemainder, singleLength);
                // 提示信息
                const messageEl = document.getElementById('smart-add-message');
                const originalText = messageEl.textContent;
                messageEl.textContent = `已自动生成${count}条 ${currentRemainder.toFixed(2)}米×${singleLength.toFixed(2)}米的地胶`;
                messageEl.classList.remove('text-orange-500', 'text-blue-500');
                messageEl.classList.add('text-green-500');
                setTimeout(() => {
                    messageEl.textContent = originalText;
                    messageEl.classList.remove('text-green-500');
                    messageEl.classList.add('text-orange-500');
                }, 5000);
                // 隐藏分段弹窗
                hideSegmentModal();
            }

            // 画布大小调整/场地尺寸更新/缩放比例计算
            function resizeCanvas() {
                const container = document.getElementById('canvas-container');
                CANVAS_WIDTH = container.clientWidth;
                if (fieldLength > 0 && fieldWidth > 0) {
                    calculateScale();
                    CANVAS_HEIGHT = fieldWidth * scale + 2 * MARGIN + 100;
                } else {
                    CANVAS_HEIGHT = 400;
                }
                canvas.width = CANVAS_WIDTH;
                canvas.height = CANVAS_HEIGHT;
                if (fieldLength > 0 && fieldWidth > 0) drawCanvas();
            }
            function updateFieldDimensions() {
                const length = document.getElementById('field-length').value;
                const width = document.getElementById('field-width').value;
                const fieldDimensionsEl = document.getElementById('field-dimensions');
                if (fieldDimensionsEl) {
                    fieldDimensionsEl.textContent = length && width ? `${parseFloat(width).toFixed(1)}米 × ${parseFloat(length).toFixed(1)}米` : "未设置";
                }
            }
            function calculateScale() {
                const availableWidth = CANVAS_WIDTH - 2 * MARGIN;
                scale = availableWidth / fieldLength;
                FIELD_X = MARGIN;
                FIELD_Y = (CANVAS_HEIGHT - fieldWidth * scale) / 2;
            }

            // 获取标准地胶宽度/添加自定义地胶
            function getStandardMatWidth() {
                return parseFloat(document.querySelector('input[name="standard-mat-width"]:checked').value);
            }
            function addCustomMat() {
                const widthInputs = document.querySelectorAll('.custom-mat-width');
                const lengthInputs = document.querySelectorAll('.custom-mat-length');
                const customMats = [];
                widthInputs.forEach((widthInput, index) => {
                    const width = parseFloat(widthInput.value);
                    const length = parseFloat(lengthInputs[index].value);
                    if (!isNaN(width) && !isNaN(length) && width > 0 && length > 0) customMats.push({ width, height: length });
                });
                if (customMats.length === 0) {
                    const messageEl = document.getElementById('smart-add-message');
                    const originalText = messageEl.textContent;
                    messageEl.textContent = "请输入有效的自定义地胶尺寸！";
                    messageEl.classList.remove('text-orange-500'); messageEl.classList.add('text-red-500');
                    setTimeout(() => { messageEl.textContent = originalText; messageEl.classList.remove('text-red-500'); messageEl.classList.add('text-orange-500'); }, 3000);
                    return;
                }
                calculateScale();
                let currentY = FIELD_Y;
                if (mats.length > 0) currentY = mats[mats.length - 1].y + mats[mats.length - 1].width * scale + 5;
                customMats.forEach((mat) => {
                    mats.push({ x: FIELD_X, y: currentY, width: mat.width, height: mat.height, color: REMAINDER_MAT_COLOR, rotation: 0, isStandard: false });
                    currentY += mat.width * scale + 5;
                });
                resizeCanvas();
                updateMatConfig();
                document.getElementById('reset-btn').disabled = false;
                document.getElementById('copy-btn').disabled = false;
                updateSmartAddButtonState();
                drawCanvas();
            }

            // 核心：智能添加地胶（最终版余数逻辑）
            function smartAddMats() {
                const standardMatWidth = getStandardMatWidth();
                if (standardMatWidth !== 1.8) { showModal("智能添加只支持1.8米宽幅"); return; }
                if (fieldLength <= 0 || fieldWidth <= 0) {
                    const messageEl = document.getElementById('smart-add-message');
                    const originalText = messageEl.textContent;
                    messageEl.textContent = "请先设置场地尺寸并生成地胶！";
                    messageEl.classList.remove('text-orange-500'); messageEl.classList.add('text-red-500');
                    setTimeout(() => { messageEl.textContent = originalText; messageEl.classList.remove('text-red-500'); messageEl.classList.add('text-orange-500'); }, 3000);
                    return;
                }

                // 计算余数并修复精度
                const standardMatCount = Math.floor(fieldWidth / standardMatWidth);
                let remainderWidth = precisionFix(fieldWidth - standardMatCount * standardMatWidth);
                const messageEl = document.getElementById('smart-add-message');
                const originalText = messageEl.textContent;
                messageEl.textContent = `检测到余数宽度: ${remainderWidth.toFixed(2)}米`;
                messageEl.classList.remove('text-orange-500'); messageEl.classList.add('text-blue-500');

                // 余数区间判断（最终版：移除<0.4提示，替换为自定义分段）
                if (remainderWidth < 0.4) {
                    // 显示自定义分段弹窗，移除原有提示
                    showSegmentModal(remainderWidth);
                } else if (remainderWidth === 0.4) {
                    const matLength = precisionFix(fieldLength / 4);
                    addSmartMats(4, remainderWidth, matLength);
                    messageEl.textContent = `已自动生成4条 ${remainderWidth.toFixed(2)}米×${matLength.toFixed(2)}米的地胶`;
                    messageEl.classList.remove('text-blue-500'); messageEl.classList.add('text-green-500');
                    setTimeout(() => { messageEl.textContent = originalText; messageEl.classList.remove('text-green-500'); messageEl.classList.add('text-orange-500'); }, 5000);
                } else if (remainderWidth > 0.4 && remainderWidth < 0.6) {
                    const matLength = precisionFix(fieldLength / 3);
                    addSmartMats(3, remainderWidth, matLength);
                    messageEl.textContent = `已自动生成3条 ${remainderWidth.toFixed(2)}米×${matLength.toFixed(2)}米的地胶`;
                    messageEl.classList.remove('text-blue-500'); messageEl.classList.add('text-green-500');
                    setTimeout(() => { messageEl.textContent = originalText; messageEl.classList.remove('text-green-500'); messageEl.classList.add('text-orange-500'); }, 5000);
                } else if (remainderWidth === 0.6) {
                    const matLength = precisionFix(fieldLength / 3);
                    addSmartMats(3, remainderWidth, matLength);
                    messageEl.textContent = `已自动生成3条 ${remainderWidth.toFixed(2)}米×${matLength.toFixed(2)}米的地胶`;
                    messageEl.classList.remove('text-blue-500'); messageEl.classList.add('text-green-500');
                    setTimeout(() => { messageEl.textContent = originalText; messageEl.classList.remove('text-green-500'); messageEl.classList.add('text-orange-500'); }, 5000);
                } else if (remainderWidth > 0.6 && remainderWidth <= 0.9) {
                    const matLength = precisionFix(fieldLength / 2);
                    addSmartMats(2, remainderWidth, matLength);
                    messageEl.textContent = `已自动生成2条 ${remainderWidth.toFixed(2)}米×${matLength.toFixed(2)}米的地胶`;
                    messageEl.classList.remove('text-blue-500'); messageEl.classList.add('text-green-500');
                    setTimeout(() => { messageEl.textContent = originalText; messageEl.classList.remove('text-green-500'); messageEl.classList.add('text-orange-500'); }, 5000);
                } else if (remainderWidth > 0.9 && remainderWidth <= 1.2) {
                    // 0.9<余数≤1.2：左1条(余数宽×场地长/3*2) + 右2条(余数宽/2×场地长/3) 组合填充
                    const leftLength = precisionFix(fieldLength / 3 * 2);
                    const rightWidth = precisionFix(remainderWidth / 2);
                    const rightLength = precisionFix(leftLength / 2);
                    addSmartMatsNew(remainderWidth, leftLength, rightWidth, rightLength);
                    messageEl.textContent = `已自动填充：左侧1条${remainderWidth.toFixed(2)}×${leftLength.toFixed(2)}米，右侧2条${rightWidth.toFixed(2)}×${rightLength.toFixed(2)}米（上下排列）`;
                    messageEl.classList.remove('text-blue-500'); messageEl.classList.add('text-green-500');
                    setTimeout(() => { messageEl.textContent = originalText; messageEl.classList.remove('text-green-500'); messageEl.classList.add('text-orange-500'); }, 5000);
                } else {
                    // 余数>1.2：直接生成1条 余数宽 × 场地总长 的地胶
                    addSmartMatsSingle(remainderWidth, fieldLength);
                    messageEl.textContent = `已自动生成1条 ${remainderWidth.toFixed(2)}米×${fieldLength.toFixed(2)}米的地胶（余数宽×场地总长）`;
                    messageEl.classList.remove('text-blue-500'); messageEl.classList.add('text-green-500');
                    setTimeout(() => { messageEl.textContent = originalText; messageEl.classList.remove('text-green-500'); messageEl.classList.add('text-orange-500'); }, 5000);
                }
            }

            // 余数>1.2专用：生成单条 余数宽×场地总长 的地胶
            function addSmartMatsSingle(width, height) {
                calculateScale();
                const standardMatWidth = getStandardMatWidth();
                const standardMatCount = Math.floor(fieldWidth / standardMatWidth);
                const remainderY = FIELD_Y + standardMatCount * standardMatWidth * scale;
                // 清除原有智能地胶
                mats = mats.filter(mat => !mat.isSmart);
                const color = REMAINDER_MAT_COLOR;
                // 添加单条地胶
                mats.push({
                    x: FIELD_X,
                    y: remainderY,
                    width: width,
                    height: height,
                    color: color,
                    rotation: 0,
                    isStandard: false,
                    isSmart: true
                });
                // 调整画布并更新
                resizeCanvas();
                updateMatConfig();
                document.getElementById('reset-btn').disabled = false;
                document.getElementById('copy-btn').disabled = false;
                drawCanvas();
            }

            // 0.9<余数≤1.2专用：左1条+右2条 组合填充
            function addSmartMatsNew(remainderWidth, leftLength, rightWidth, rightLength) {
                calculateScale();
                const standardMatWidth = getStandardMatWidth();
                const standardMatCount = Math.floor(fieldWidth / standardMatWidth);
                const remainderY = FIELD_Y + standardMatCount * standardMatWidth * scale;
                // 清除原有智能地胶
                mats = mats.filter(mat => !mat.isSmart);
                const color = REMAINDER_MAT_COLOR;

                // 1. 左侧：1条 余数宽 * 左侧长度（场地长/3*2）
                mats.push({
                    x: FIELD_X,
                    y: remainderY,
                    width: remainderWidth,
                    height: leftLength,
                    color: color,
                    rotation: 0,
                    isStandard: false,
                    isSmart: true
                });

                // 2. 右侧：2条 余数/2宽 * 左侧长度/2长（上下排列）
                const rightStartX = FIELD_X + leftLength * scale; // 右侧起始X：左侧地胶结束位置
                // 上侧小地胶
                mats.push({
                    x: rightStartX,
                    y: remainderY,
                    width: rightWidth,
                    height: rightLength,
                    color: color,
                    rotation: 0,
                    isStandard: false,
                    isSmart: true
                });
                // 下侧小地胶（Y轴偏移：上侧地胶宽度）
                mats.push({
                    x: rightStartX,
                    y: remainderY + rightWidth * scale,
                    width: rightWidth,
                    height: rightLength,
                    color: color,
                    rotation: 0,
                    isStandard: false,
                    isSmart: true
                });

                // 调整画布并更新
                resizeCanvas();
                updateMatConfig();
                document.getElementById('reset-btn').disabled = false;
                document.getElementById('copy-btn').disabled = false;
                drawCanvas();
            }

            // 通用智能添加：生成N条等长地胶（适配0.4~0.9米+自定义分段）
            function addSmartMats(count, width, length) {
                calculateScale();
                const standardMatWidth = getStandardMatWidth();
                const standardMatCount = Math.floor(fieldWidth / standardMatWidth);
                const remainderY = FIELD_Y + standardMatCount * standardMatWidth * scale;
                mats = mats.filter(mat => !mat.isSmart);
                const color = REMAINDER_MAT_COLOR;
                for (let i = 0; i < count; i++) {
                    const x = FIELD_X + i * length * scale;
                    mats.push({ x, y: remainderY, width, height: length, color, rotation: 0, isStandard: false, isSmart: true });
                }
                resizeCanvas();
                updateMatConfig();
                document.getElementById('reset-btn').disabled = false;
                document.getElementById('copy-btn').disabled = false;
                drawCanvas();
            }

            // 更新地胶配置/生成地胶/重置
            function updateMatConfig() {
                let totalWidth = 0;
                mats.forEach(mat => totalWidth += mat.width);
                const coverage = fieldWidth > 0 ? ((totalWidth / fieldWidth) * 100).toFixed(1) : 0;
                const matConfigEl = document.getElementById('mat-config');
                if (matConfigEl) matConfigEl.textContent = `${mats.length}条地胶，总宽度 ${totalWidth.toFixed(2)}米 (覆盖场地 ${coverage}%)`;
            }
            function generateMats() {
                const lengthInput = document.getElementById('field-length').value;
                const widthInput = document.getElementById('field-width').value;
                if (!lengthInput || !widthInput) { showModal("请输入场地的长度和宽度", true); return; }
                fieldLength = parseFloat(lengthInput);
                fieldWidth = parseFloat(widthInput);
                if (isNaN(fieldLength) || isNaN(fieldWidth) || fieldLength <= 0 || fieldWidth <= 0) {
                    const messageEl = document.getElementById('smart-add-message');
                    const originalText = messageEl.textContent;
                    messageEl.textContent = "请输入有效的正数尺寸！";
                    messageEl.classList.remove('text-orange-500'); messageEl.classList.add('text-red-500');
                    setTimeout(() => { messageEl.textContent = originalText; messageEl.classList.remove('text-red-500'); messageEl.classList.add('text-orange-500'); }, 3000);
                    return;
                }
                mats = [];
                resizeCanvas();
                calculateScale();
                const standardMatWidth = getStandardMatWidth();
                const standardMatCount = Math.floor(fieldWidth / standardMatWidth);
                for (let i = 0; i < standardMatCount; i++) {
                    const x = FIELD_X;
                    const y = FIELD_Y + i * standardMatWidth * scale;
                    const hue = 195 + (i * 30) % 120;
                    const color = `hsl(${hue}, 70%, 50%)`;
                    mats.push({ x, y, width: standardMatWidth, height: fieldLength, color, rotation: 0, isStandard: true });
                }
                updateMatConfig();
                document.getElementById('reset-btn').disabled = false;
                document.getElementById('copy-btn').disabled = false;
                updateSmartAddButtonState();
                document.getElementById('empty-canvas-message').style.display = 'none';
                drawCanvas();
            }
            function reset() {
                mats = [];
                document.getElementById('field-length').value = '';
                document.getElementById('field-width').value = '';
                const fieldDimensionsEl = document.getElementById('field-dimensions');
                if (fieldDimensionsEl) fieldDimensionsEl.textContent = "未设置";
                const matConfigEl = document.getElementById('mat-config');
                if (matConfigEl) matConfigEl.textContent = "未生成";
                document.querySelectorAll('.custom-mat-width').forEach(input => input.value = '');
                document.querySelectorAll('.custom-mat-length').forEach(input => input.value = '');
                document.getElementById('empty-canvas-message').style.display = 'flex';
                document.getElementById('smart-add-btn').disabled = true;
                const messageEl = document.getElementById('smart-add-message');
                messageEl.textContent = "智能添加只支持1.8米宽幅地胶";
                messageEl.classList.remove('text-red-500', 'text-green-500', 'text-blue-500');
                messageEl.classList.add('text-orange-500');
                resizeCanvas();
                drawCanvas();
                document.getElementById('reset-btn').disabled = true;
                document.getElementById('copy-btn').disabled = true;
            }

            // 删除地胶/鼠标事件/旋转地胶
            function deleteSelectedMat(index) {
                if (index >= 0) {
                    saveState();
                    mats.splice(index, 1);
                    updateMatConfig();
                    if (mats.length === 0) {
                        document.getElementById('empty-canvas-message').style.display = 'flex';
                        document.getElementById('reset-btn').disabled = true;
                        document.getElementById('copy-btn').disabled = true;
                        document.getElementById('smart-add-btn').disabled = true;
                    } else {
                        updateSmartAddButtonState();
                    }
                    resizeCanvas();
                    drawCanvas();
                }
            }
            function handleMouseDown(e) {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                for (let i = mats.length - 1; i >= 0; i--) {
                    const mat = mats[i];
                    const cos = Math.cos(mat.rotation);
                    const sin = Math.sin(mat.rotation);
                    const centerX = mat.x + mat.height * scale / 2;
                    const centerY = mat.y + mat.width * scale / 2;
                    const relX = mouseX - centerX;
                    const relY = mouseY - centerY;
                    const rotatedX = relX * cos + relY * sin;
                    const rotatedY = -relX * sin + relY * cos;
                    if (Math.abs(rotatedX) <= mat.height * scale / 2 && Math.abs(rotatedY) <= mat.width * scale / 2) {
                        if (isShiftKeyDown) {
                            deleteSelectedMat(i);
                        } else {
                            startMatState = JSON.parse(JSON.stringify(mat));
                            isStateSaved = false;
                            const selectedMat = mats.splice(i, 1)[0];
                            mats.push(selectedMat);
                            isDragging = true;
                            draggedMatIndex = mats.length - 1;
                            offsetX = mouseX - selectedMat.x;
                            offsetY = mouseY - selectedMat.y;
                        }
                        drawCanvas();
                        return;
                    }
                }
            }
            function handleMouseMove(e) {
                if (!isDragging) return;
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                let newX = mouseX - offsetX;
                let newY = mouseY - offsetY;
                const draggedMat = mats[draggedMatIndex];
                newX = Math.max(FIELD_X, Math.min(newX, FIELD_X + fieldLength * scale - draggedMat.height * scale));
                newY = Math.max(FIELD_Y, Math.min(newY, FIELD_Y + fieldWidth * scale - draggedMat.width * scale));
                if (Math.abs(newX - FIELD_X) < SNAP_THRESHOLD) newX = FIELD_X;
                if (Math.abs(newX - (FIELD_X + fieldLength * scale - draggedMat.height * scale)) < SNAP_THRESHOLD) newX = FIELD_X + fieldLength * scale - draggedMat.height * scale;
                if (Math.abs(newY - FIELD_Y) < SNAP_THRESHOLD) newY = FIELD_Y;
                if (Math.abs(newY - (FIELD_Y + fieldWidth * scale - draggedMat.width * scale)) < SNAP_THRESHOLD) newY = FIELD_Y + fieldWidth * scale - draggedMat.width * scale;
                const hasMoved = Math.abs(draggedMat.x - newX) > 0.1 || Math.abs(draggedMat.y - newY) > 0.1;
                if (hasMoved && !isStateSaved) { saveState(); isStateSaved = true; }
                draggedMat.x = newX;
                draggedMat.y = newY;
                drawCanvas();
            }
            function handleMouseUp() {
                isDragging = false;
                draggedMatIndex = -1;
                startMatState = null;
                isStateSaved = false;
            }
            function rotateMat(index) {
                mats[index].rotation += Math.PI / 2;
                drawCanvas();
            }

            // 绘制画布
            function drawCanvas() {
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                if (fieldLength <= 0 || fieldWidth <= 0) return;
                // 绘制场地边界
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 3;
                ctx.strokeRect(FIELD_X, FIELD_Y, fieldLength * scale, fieldWidth * scale);
                // 场地标注
                ctx.fillStyle = '#333';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`场地：${fieldWidth.toFixed(1)}米（宽） × ${fieldLength.toFixed(1)}米（长）`, FIELD_X + fieldLength * scale / 2, FIELD_Y - 20);
                // 绘制余数区域背景
                const standardMatWidth = getStandardMatWidth();
                const standardMatCount = Math.floor(fieldWidth / standardMatWidth);
                const remainderWidth = precisionFix(fieldWidth - standardMatCount * standardMatWidth);
                const hasSmartMats = mats.some(mat => mat.isSmart);
                if (remainderWidth > 0 && !hasSmartMats) {
                    const remainderY = FIELD_Y + standardMatCount * standardMatWidth * scale;
                    ctx.fillStyle = 'rgba(255, 99, 71, 0.1)';
                    ctx.fillRect(FIELD_X, remainderY, fieldLength * scale, remainderWidth * scale);
                    ctx.strokeStyle = 'rgba(255, 99, 71, 0.5)';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(FIELD_X, remainderY, fieldLength * scale, remainderWidth * scale);
                }
                // 绘制地胶
                for (let i = 0; i < mats.length; i++) {
                    const mat = mats[i];
                    ctx.save();
                    ctx.translate(mat.x + mat.height * scale / 2, mat.y + mat.width * scale / 2);
                    ctx.rotate(mat.rotation);
                    ctx.fillStyle = mat.color;
                    ctx.fillRect(-mat.height * scale / 2, -mat.width * scale / 2, mat.height * scale, mat.width * scale);
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(-mat.height * scale / 2, -mat.width * scale / 2, mat.height * scale, mat.width * scale);
                    // 地胶尺寸标注
                    ctx.font = `bold ${matFontSize}px Arial`;
                    ctx.fillStyle = '#333';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const isHorizontal = Math.abs(Math.sin(mat.rotation)) < 0.1 || Math.abs(Math.cos(mat.rotation)) < 0.1;
                    const widthText = isHorizontal ? mat.width.toFixed(2) : mat.height.toFixed(2);
                    const heightText = isHorizontal ? mat.height.toFixed(2) : mat.width.toFixed(2);
                    ctx.fillText(`${widthText}米*${heightText}米`, 0, 0);
                    ctx.restore();
                }
                // 余数区域文字
                if (remainderWidth > 0 && !hasSmartMats) {
                    const remainderY = FIELD_Y + standardMatCount * standardMatWidth * scale;
                    ctx.fillStyle = 'rgba(255, 99, 71, 0.7)';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`余数区域: ${remainderWidth.toFixed(2)}米`, FIELD_X + fieldLength * scale / 2, remainderY + remainderWidth * scale / 2);
                }
            }

            // 初始化
            function init() {
                resizeCanvas();
                initEvents();
                drawCanvas();
                updateSmartAddButtonState();
                updateUndoButtonState();
            }
            init();
        });
    </script>
</body>
</html>
